<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>write file « Pei LiPing's Blog</title>
  <meta name="description" content="最近在优化一些shell脚本任务，涉及到对文件的读写过程，这里聊聊我碰到的一些问题。">

  <link rel="stylesheet" href="/blog/css/main.css">
  <link rel="canonical" href="http://peiliping.github.io/blog/archivers/2021-07-28-writefile">
  <link rel="alternate" type="application/rss+xml" title="Pei LiPing's Blog" href="http://peiliping.github.io/blog/feed.xml" />
</head>


  <body>

    <header class="header">
  <div class="wrapper">
    <a class="site-title" href="/blog/">Pei LiPing's Blog</a>
    <nav class="site-nav">
      
        
      
        
        <a class="page-link" href="/blog/about/">About</a>
        
      
        
        <a class="page-link" href="/blog/category/">Category</a>
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    </nav>
  </div>
</header>

    <div class="page-content">
      <div class="wrapper">
        <div class="col-main">
          <div class="post">

  <header class="post-header">
    <h1 class="post-title">write file</h1>
    <p class="post-meta">Jul 28, 2021</p>
  </header>

  <article class="post-content">
    <p>最近在优化一些shell脚本任务，涉及到对文件的读写过程，这里聊聊我碰到的一些问题。</p>

<p>我的脚本主要是对数据进行统计和计算，数据具有时序性，每分钟会有一行结果存在结果文件中。</p>

<p>脚本每分钟执行一次，每次计算上一分钟和当前分钟的结果。保存结果数据时，会涉及到删除结果文件的最后一行，因为最后一分钟会被修正。</p>

<h2 id="section">如何衔接两次任务的时间</h2>

<p>数据结果的文件每一行都对应一分钟的数据，每行开头都记录对应的时间戳。</p>

<p>每次任务开始时，都读取结果文件的末尾，计算合理的数据时间。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>
thishourday=`date "+%Y-%m-%d"`
startTime=`date -d "${thishourday}" +%s`

if [ -f "$rfile" ]; then
  startTime=`tail -n 1 $rfile | awk '{print $1}'`
else
  touch $rfile
fi

</code></pre>
</div>

<h2 id="dailyrolling">原始数据文件有DailyRolling</h2>

<p>这就意味着每天00:00处理数据时，需要读取前一天的文件和当天文件。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>
starthourday=`date --date=@${startTime} "+%Y-%m-%d"`

if [ $starthourday = $thishourday  ];then
  dfile=$dfile
else
  dfile=$dfile"-"$starthourday" "$dfile
fi

</code></pre>
</div>

<h2 id="section-1">保存计算结果</h2>

<p>每次计算任务完成后，都先将数据写入临时文件tfile中，接下来我们删除结果文件的最后一行。</p>

<p>删除我们用了一个简单的命令</p>

<div class="highlighter-rouge"><pre class="highlight"><code>
sed -i '$ d' $rfile

</code></pre>
</div>

<p>最后我们将临时文件Merge到结果文件的末尾，删除临时文件。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>
cat $tfile &gt;&gt; $rfile
rm -rf $tfile

</code></pre>
</div>

<h2 id="section-2">性能问题</h2>

<p>如果结果文件越来越大，这个任务会越来越慢，主要的性能问题在删除文件最后一行这一步。</p>

<p>sed删除最后一行这样的方式，几乎等于把整个文件重写了一遍。有兴趣的朋友可以看看这篇<a href="https://www.codenong.com/4881930/">Blog</a>。</p>

<p>我觉得出现这个问题本身就代表了设计问题，临时数据（最后一行）是否要直接写入结果文件？</p>

<p>可以借鉴Compaction那样的思路，将不确定的临时数据写入临时文件，当可以确定时写入正式的结果文件中,规避性能问题。</p>

<p>最好还是把这些数据存入数据库吧，时序数据库千千万。</p>

  </article>
  
  




</div>

        </div>
        <div class="col-second">
          <div class="col-box col-box-author">
  <img class="avatar" src="//www.gravatar.com/avatar/your_email_md5?d=mm&s=135" alt="Pei LiPing">
  <div class="col-box-title name">Pei LiPing</div>
  <p>The Cabin Of Pei LiPing.</p>
  <p class="contact">
    
    
    
    <a href="mailto:peilipingplp@gmail.com">Email</a>
    
  </p>
</div>

<div class="col-box">
  <div class="col-box-title">Newest Posts</div>
  <ul class="post-list">
    
      <li><a class="post-link" href="/blog/archivers/2021-10-10-baby">Baby</a></li>
    
      <li><a class="post-link" href="/blog/archivers/2021-09-11-wyckoff2">Wyckoff2</a></li>
    
      <li><a class="post-link" href="/blog/archivers/2021-08-19-wyckoff">Wyckoff</a></li>
    
      <li><a class="post-link" href="/blog/archivers/2021-07-28-writefile">write file</a></li>
    
      <li><a class="post-link" href="/blog/archivers/2021-06-13-flock">flock</a></li>
    
  </ul>
</div>

<div class="col-box post-toc hide">
  <div class="col-box-title">TOC</div>
</div>
        </div>
      </div>
    </div>

    <footer class="footer">
<div class="wrapper">
&copy; 2016 Pei LiPing
</div>
</footer>

<script src="//upcdn.b0.upaiyun.com/libs/jquery/jquery-1.9.0.min.js"></script>
<script src="/blog/js/easybook.js"></script>

  </body>

</html>
