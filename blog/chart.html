<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://code.highcharts.com.cn/jquery/jquery-1.8.3.min.js"></script>
        <script src="https://cdn.highcharts.com.cn/highstock/highstock.js"></script>
        <script src="https://cdn.highcharts.com.cn/highcharts/modules/exporting.js"></script>
        <script src="https://code.highcharts.com.cn/highcharts-plugins/highcharts-zh_CN.js"></script>
        <style>
            *{
                margin: 0;
                padding: 0;
            }
            div{
                width:100%;
                height: 100%;
                position: absolute;
            }
        </style>
    </head>
    <body>
        <div id="container"></div>
        <script>
            var result = {
                positions : [],
                prices : []
            };
            function chart(){
                Highcharts.stockChart('container', {
                    title: {
                        text: 'Price & Position'
                    },
                    time: {
                        useUTC: false
                    },                 
                    rangeSelector: {
                        buttons: [
                            {
                                type: 'day',
                                count: 1,
                                text: '1day',
                                title: 'View 1 day'
                            }, {
                                type: 'week',
                                count: 1,
                                text: '1w',
                                title: 'View 1 week'
                            }, {
                                type: 'month',
                                count: 1,
                                text: '1m',
                                title: 'View 1 month'
                            }, {
                                type: 'all',
                                text: 'All',
                                title: 'View all'
                            }
                        ],
                        selected: 1
                    },
                    yAxis: [
                        {
                            labels: {
                                style: {
                                    color: Highcharts.getOptions().colors[0]
                                }
                            },
                            title: {
                                text: '价格',
                                style: {
                                    color: Highcharts.getOptions().colors[0]
                                }
                            },
                            opposite: false
                        }, {
                            title: {
                                text: '仓位差',
                                style: {
                                    color: Highcharts.getOptions().colors[1]
                                }
                            },
                            labels: {
                                style: {
                                    color: Highcharts.getOptions().colors[1]
                                }
                            },
                            opposite: true
                        }
                    ],        
                    tooltip: {
                        shared: true
                    },
                    series: [{
                        name: 'Price',
                        type: 'spline',
                        yAxis: 0,
                        data: result.prices,
                    },{
                        name: 'Position',
                        type: 'spline',
                        yAxis: 1,
                        data: result.positions
                    }]
                });
            }

            $.getJSON('https://fapi.binance.com/fapi/v1/klines?symbol=btcusdt&interval=30m&limit=1500', function (data) {
                for (var i = 0; i < data.length; i++){                     
                    var item = [data[i][0] , parseFloat(data[i][4])];
                    result.prices.push(item);
                }
                var now = new Date().getTime();
                function getRatio(startTime){
                    var endTime = startTime + 86400000 * 10;
                    var ps = "symbol=BTCUSDT&period=30m&limit=500&starttime=" + startTime + "&endTime=" + endTime;
                    $.getJSON('https://fapi.binance.com/futures/data/globalLongShortAccountRatio?' + ps, function (data) {
                        for (var i = 0; i < data.length; i++){                     
                            var item = [data[i]["timestamp"] , (data[i]["longAccount"] - data[i]["shortAccount"])];
                            result.positions.push(item);
                        }
                        if(endTime < now){
                            getRatio(endTime);
                        }else{
                            chart();
                        }   
                    });
                } 
                getRatio(parseInt(now / 3600000) * 3600000 - 86400000 * 28);
            });
        </script>
    </body>
</html>