<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://code.highcharts.com.cn/jquery/jquery-1.8.3.min.js"></script>
        <script src="https://cdn.highcharts.com.cn/highstock/highstock.js"></script>
        <script src="https://code.highcharts.com.cn/highcharts-plugins/highcharts-zh_CN.js"></script>
        <style>
            *{
                margin: 0;
                padding: 0;
            }
            div{
                width:100%;
                height: 100%;
                position: absolute;
            }
        </style>
    </head>
    <body>
        <div id="container"></div>
        <script>
        	function getUrlParam(name) {
            	var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            	var r = window.location.search.substr(1).match(reg);
            	if (r != null) return unescape(r[2]); return null;
        	}

        	var now = new Date().getTime();
            var result = {
                prices : [],
                globalPositions : [],
                topPositions : [],
                opens : [],
                events : [],
				symbol : getUrlParam('symbol'),
                now : now,
                beginning : parseInt(now / 3600000) * 3600000 - 86400000 * 28,
            };          

            function chart(){
                console.log(JSON.stringify(result.globalPositions));
                console.log(JSON.stringify(result.opens));
                Highcharts.stockChart('container', {
                    title: {
                        text: 'Price & Position'
                    },
                    time: {
                        useUTC: false
                    },
                    legend: {
						enabled: true
					},
					tooltip: {
                        shared: true,
                    },
                    chart: {
                    	animation: false
                    },
                    rangeSelector: {
                        buttons: [
                            {
                                type: 'day',
                                count: 1,
                                text: '1day',
                                title: 'View 1 day'
                            }, {
                                type: 'week',
                                count: 1,
                                text: '1w',
                                title: 'View 1 week'
                            }, {
                                type: 'month',
                                count: 1,
                                text: '1m',
                                title: 'View 1 month'
                            }, {
                                type: 'all',
                                text: 'All',
                                title: 'View all'
                            }
                        ],
                        selected: 1
                    },
                    yAxis: [
                    	{                            
                            title: {
                                text: '价格',
                                style: {
                                    color: Highcharts.getOptions().colors[0]
                                }
                            },
                            labels: {
                                style: {
                                    color: Highcharts.getOptions().colors[0]
                                }
                            },
                            opposite: false,
                            height: '85%',
                        }, {
                            title: {
                                text: '仓位差',
                                style: {
                                    color: Highcharts.getOptions().colors[1]
                                }
                            },
                            labels: {
                                style: {
                                    color: Highcharts.getOptions().colors[1]
                                }
                            },
                            opposite: true,
                            height: '85%',
                        },{
                        	title: {
                                text: '开仓量',
                                style: {
                                    color: Highcharts.getOptions().colors[1]
                                }
                            },
							labels: {
								style: {
                                    color: Highcharts.getOptions().colors[1]
                                },
								align: 'left'
							},
							top: '85%',
							height: '15%',
							offset: 0
						}
					],        
                    series: [{
                        name: 'Prices',
                        type: 'candlestick',
                        yAxis: 0,
                        data: result.prices,
                    },{
                        name: 'GlobalPositions',
                        type: 'spline',
                        yAxis: 1,
                        data: result.globalPositions,
                    },{
                        name: 'TopPositions',
                        type: 'spline',
                        yAxis: 1,
                        data: result.topPositions,
                        visible: false,
                    },{
                    	name: 'Opens',
                        type: 'spline',
                        yAxis: 2,
                        data: result.opens,
                    },{
                    	name: 'FundingRates',
						type: 'flags',
						data: result.events,
						shape: 'squarepin',
						width: 16,
						enableMouseTracking: false,
					}]
                });
            }

            function getKlines(){
            	var symbol = result.symbol.toLowerCase();
				$.getJSON('https://fapi.binance.com/fapi/v1/klines?symbol=' + symbol + 'usdt&interval=30m&limit=1350&_ts=' + now, function (data) {
                	for (var i = 0; i < data.length; i++){                     
                    	var item = [data[i][0] , parseFloat(data[i][1]), parseFloat(data[i][2]), parseFloat(data[i][3]), parseFloat(data[i][4])];
                    	result.prices.push(item);
                	}
                	chart();
            	});
            }

			function getFundingRates(){
            	var symbol = result.symbol.toUpperCase();
            	$.getJSON('https://fapi.binance.com/fapi/v1/fundingRate?symbol=' + symbol + 'USDT&limit=100&_ts=' + now, function (data) {
                	for (var i = 0; i < data.length; i++){                     
                		var ts = parseInt(data[i].fundingTime /1000) * 1000;
                		var ratio = parseFloat(data[i].fundingRate);
                		if(ratio < -0.00001){
                			var item = {x: ts, title: "S"};
                			result.events.push(item);
                		}
                	}
                	getKlines();
            	});
            }

            function getTopPositions(startTime){
                var symbol = result.symbol.toUpperCase();
                var endTime = startTime + 86400000 * 10;
                var ps = 'symbol=' + symbol + 'USDT&period=30m&limit=500&starttime=' + startTime + '&endTime=' + endTime + '&_ts=' + now;
                $.getJSON('https://fapi.binance.com/futures/data/topLongShortAccountRatio?' + ps, function (data) {
                    for (var i = 0; i < data.length; i++){ 
                    	var w = Math.floor((data[i].longAccount - data[i].shortAccount)*1000)/1000;
                        var item = [data[i].timestamp , w];
                        result.topPositions.push(item);
                    }
                    if(endTime < now){
                        getTopPositions(endTime);
                    }else{
                        getFundingRates();
                    }
                });
            }

            function getGlobalPositions(startTime){
                var symbol = result.symbol.toUpperCase();
                var endTime = startTime + 86400000 * 10;
                var ps = 'symbol=' + symbol + 'USDT&period=30m&limit=500&starttime=' + startTime + '&endTime=' + endTime + '&_ts=' + now;
                $.getJSON('https://fapi.binance.com/futures/data/globalLongShortAccountRatio?' + ps, function (data) {
                    for (var i = 0; i < data.length; i++){ 
                    	var w = Math.floor((data[i].longAccount - data[i].shortAccount)*1000)/1000;
                        var item = [data[i].timestamp , w];
                        result.globalPositions.push(item);
                    }
                    if(endTime < now){
                        getGlobalPositions(endTime);
                    }else{
                    	document.title = 'PD : ' + result.globalPositions[result.globalPositions.length-1][1]
                        getTopPositions(result.beginning);
                    }
                });
            }

            function getOpens(startTime){
                var symbol = result.symbol.toUpperCase();
                var endTime = startTime + 86400000 * 10;
                var ps = 'symbol=' + symbol + 'USDT&period=30m&limit=500&starttime=' + startTime + '&endTime=' + endTime + '&_ts=' + now;
                $.getJSON('https://fapi.binance.com/futures/data/openInterestHist?' + ps, function (data) {
                    for (var i = 0; i < data.length; i++){
                    	if(data[i].sumOpenInterest > 0){
                    		var item = [data[i].timestamp , parseFloat(data[i].sumOpenInterest)];
                        	result.opens.push(item);	
                    	}
                    }
                    if(endTime < now){
                        getOpens(endTime);
                    }else{
                        getGlobalPositions(result.beginning);
                    }   
                });
            }

            if(result.symbol == null || result.symbol == ''){
            	alert('symbol is missing .');
            }else{
            	getOpens(result.beginning);
            }
        </script>
    </body>
</html>