<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://code.highcharts.com.cn/jquery/jquery-1.8.3.min.js"></script>
        <script src="https://cdn.highcharts.com.cn/highstock/highstock.js"></script>
        <script src="https://cdn.highcharts.com.cn/highcharts/modules/exporting.js"></script>
        <script src="https://code.highcharts.com.cn/highcharts-plugins/highcharts-zh_CN.js"></script>
        <style>
            *{
                margin: 0;
                padding: 0;
            }
            div{
                width:100%;
                height: 100%;
                position: absolute;
            }
        </style>
    </head>
    <body>
        <div id="container"></div>
        <script>
        	function getUrlParam(name) {
            	var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            	var r = window.location.search.substr(1).match(reg);
            	if (r != null) return unescape(r[2]); return null;
        	}

        	var symbol = getUrlParam('symbol');
        	var now = new Date().getTime();
        	var beginning = parseInt(now / 3600000) * 3600000 - 86400000 * 28;

            var result = {
                positions : [],
                prices : [],
                opens : []
            };            

            function chart(){
                console.log(JSON.stringify(result.positions));
                console.log(JSON.stringify(result.opens));
                Highcharts.stockChart('container', {
                    title: {
                        text: 'Price & Position'
                    },
                    time: {
                        useUTC: false
                    },                 
                    rangeSelector: {
                        buttons: [
                            {
                                type: 'day',
                                count: 1,
                                text: '1day',
                                title: 'View 1 day'
                            }, {
                                type: 'week',
                                count: 1,
                                text: '1w',
                                title: 'View 1 week'
                            }, {
                                type: 'month',
                                count: 1,
                                text: '1m',
                                title: 'View 1 month'
                            }, {
                                type: 'all',
                                text: 'All',
                                title: 'View all'
                            }
                        ],
                        selected: 1
                    },
                    yAxis: [
                    	{                            
                            title: {
                                text: '价格',
                                style: {
                                    color: Highcharts.getOptions().colors[0]
                                }
                            },
                            labels: {
                                style: {
                                    color: Highcharts.getOptions().colors[0]
                                }
                            },
                            opposite: false,
                            height: '80%',
                        }, {
                            title: {
                                text: '仓位差',
                                style: {
                                    color: Highcharts.getOptions().colors[1]
                                }
                            },
                            labels: {
                                style: {
                                    color: Highcharts.getOptions().colors[1]
                                }
                            },
                            opposite: true,
                            height: '80%',
                        },{
							labels: {
								align: 'left'
							},
							top: '80%',
							height: '20%',
							offset: 0
						}
					],        
                    tooltip: {
                        shared: true
                    },
                    series: [{
                        name: 'Price',
                        type: 'spline',
                        yAxis: 0,
                        data: result.prices,
                    },{
                        name: 'Position',
                        type: 'spline',
                        yAxis: 1,
                        data: result.positions,
                    },{
                    	name: 'Opens',
                        type: 'spline',
                        yAxis: 2,
                        data: result.opens,
                    }]
                });
            }

            function getKlines(){
				$.getJSON('https://fapi.binance.com/fapi/v1/klines?symbol=' + symbol.toLowerCase() + 'usdt&interval=30m&limit=1500', function (data) {
                	for (var i = 0; i < data.length; i++){                     
                    	var item = [data[i][0] , parseFloat(data[i][4])];
                    	result.prices.push(item);
                	}
                	chart();
            	});
            }

            function getRatio(startTime){
                var endTime = startTime + 86400000 * 10;
                var ps = "symbol=" + symbol.toUpperCase() + "USDT&period=30m&limit=500&starttime=" + startTime + "&endTime=" + endTime;
                $.getJSON('https://fapi.binance.com/futures/data/globalLongShortAccountRatio?' + ps, function (data) {
                    for (var i = 0; i < data.length; i++){ 
                    	var w = Math.floor((data[i]["longAccount"] - data[i]["shortAccount"])*1000)/1000;
                        var item = [data[i]["timestamp"] , w];
                        result.positions.push(item);
                    }
                    if(endTime < now){
                        getRatio(endTime);
                    }else{
                    	document.title = "PD : " + result.positions[result.positions.length-1][1]
                        getKlines();
                    }   
                });
            }

            function getOpen(startTime){
                var endTime = startTime + 86400000 * 10;
                var ps = "symbol=" + symbol.toUpperCase() + "USDT&period=30m&limit=500&starttime=" + startTime + "&endTime=" + endTime;
                $.getJSON('https://fapi.binance.com/futures/data/openInterestHist?' + ps, function (data) {
                    for (var i = 0; i < data.length; i++){                     
                        var item = [data[i]["timestamp"] , parseFloat(data[i]["sumOpenInterest"])];
                        result.opens.push(item);
                    }
                    if(endTime < now){
                        getOpen(endTime);
                    }else{
                        getRatio(beginning);
                    }   
                });
            }

            getOpen(beginning);
        </script>
    </body>
</html>